<app-layout>
  <p-toast />

  <div class="page-container">
    <!-- Page Header -->
    <div class="page-header">
      <div class="header-content">
        <h1 class="page-title">Leads Pipeline</h1>
        <p class="page-subtitle">Drag and drop to update lead status</p>
      </div>
      <div class="header-actions">
        <div class="view-toggle">
          <button
            pButton
            icon="pi pi-list"
            [outlined]="true"
            size="small"
            pTooltip="Table View"
            tooltipPosition="bottom"
            (click)="switchToTable()"
          ></button>
          <button
            pButton
            icon="pi pi-th-large"
            size="small"
            pTooltip="Kanban View"
            tooltipPosition="bottom"
            class="active-view"
          ></button>
        </div>
      </div>
    </div>

    <!-- Filters Card -->
    <div class="filter-card">
      <!-- Date Quick Filters -->
      <div class="date-filter-row">
        <span class="filter-label">Date:</span>
        <div class="date-buttons">
          @for (option of dateFilterOptions; track option.value) {
          <button
            pButton
            [label]="option.label"
            [outlined]="selectedDateFilter !== option.value"
            [severity]="
              selectedDateFilter === option.value ? 'primary' : 'secondary'
            "
            size="small"
            (click)="onDateFilterSelect(option.value)"
            class="date-filter-btn"
          ></button>
          }
        </div>
        @if (selectedDateFilter === 'custom') {
        <p-datepicker
          [(ngModel)]="customDateRange"
          selectionMode="range"
          [showIcon]="true"
          placeholder="Select range"
          dateFormat="dd/mm/yy"
          (onSelect)="onCustomDateChange()"
          class="custom-date-picker"
          appendTo="body"
        />
        } @if (selectedDateFilter) {
        <button
          pButton
          icon="pi pi-times"
          [text]="true"
          [rounded]="true"
          size="small"
          severity="danger"
          pTooltip="Clear"
          (click)="clearDateFilter()"
        ></button>
        }
      </div>

      <!-- Main Filters Row -->
      <div class="filter-row">
        <div class="filter-item search-item">
          <p-inputgroup class="search-group">
            <p-inputgroup-addon>
              <i class="pi pi-search"></i>
            </p-inputgroup-addon>
            <input
              type="text"
              pInputText
              [(ngModel)]="searchQuery"
              placeholder="Search..."
              (input)="onFilterChange()"
            />
          </p-inputgroup>
        </div>

        <div class="filter-item">
          <p-multiselect
            [options]="categories()"
            [(ngModel)]="selectedCategoryIds"
            optionLabel="name"
            optionValue="id"
            placeholder="Categories"
            [showClear]="true"
            (onChange)="onFilterChange()"
            class="filter-multiselect"
            [maxSelectedLabels]="1"
            selectedItemsLabel="{0} selected"
            appendTo="body"
          />
        </div>

        <div class="filter-item">
          <p-multiselect
            [options]="users()"
            [(ngModel)]="selectedUserIds"
            optionLabel="name"
            optionValue="id"
            placeholder="Users"
            [showClear]="true"
            (onChange)="onFilterChange()"
            class="filter-multiselect"
            appendTo="body"
            [maxSelectedLabels]="1"
            selectedItemsLabel="{0} selected"
          />
        </div>

        <div class="filter-item group-item">
          <span class="filter-label">Group:</span>
          <p-select
            [options]="groupByOptions"
            [(ngModel)]="selectedGroupBy"
            optionLabel="label"
            optionValue="value"
            (onChange)="onGroupByChange()"
            class="group-select"
            appendTo="body"
          />
        </div>
      </div>
    </div>

    <!-- Kanban Board -->
    <div class="board-container">
      <div class="kanban-board" cdkDropListGroup>
        @for (column of dynamicColumns(); track column.id) {
        <div
          class="kanban-column"
          [style.--column-color]="column.color"
          [style.--column-bg]="column.bgColor"
        >
          <div class="column-header">
            <div class="column-title">
              <i class="pi {{ column.icon }}"></i>
              <span>{{ column.title }}</span>
            </div>
            <span class="column-count">{{ column.count }}</span>
          </div>
          <div
            class="column-content"
            cdkDropList
            [cdkDropListData]="column.leads"
            [id]="column.id"
            (cdkDropListDropped)="onDrop($event, column.id)"
            [cdkDropListSortingDisabled]="true"
          >
            @for (lead of column.leads; track lead.id) {
            <div class="lead-card" cdkDrag [cdkDragData]="lead">
              <div class="card-header">
                <span class="phone-number">
                  <i class="pi pi-phone"></i>
                  {{ lead.phoneNumber }}
                </span>
              </div>
              <div class="card-body">
                <div class="customer-name">
                  {{ lead.name || "Unknown Customer" }}
                </div>
                @if (lead.category) {
                <div class="category-badge">
                  {{ lead.category.name }}
                </div>
                }
              </div>
              <div class="card-footer">
                <div class="assigned-user">
                  <i class="pi pi-user"></i>
                  {{ lead.assignedTo?.name || "Unassigned" }}
                </div>
                <div class="card-actions">
                  <button
                    pButton
                    icon="pi pi-pencil"
                    [text]="true"
                    [rounded]="true"
                    size="small"
                    pTooltip="Edit"
                    tooltipPosition="top"
                    (click)="openEditDialog(lead); $event.stopPropagation()"
                  ></button>
                  <button
                    pButton
                    icon="pi pi-comments"
                    [text]="true"
                    [rounded]="true"
                    size="small"
                    pTooltip="Chat"
                    tooltipPosition="top"
                    (click)="openFloatingChat(lead)"
                  ></button>
                  <button
                    pButton
                    icon="pi pi-eye"
                    [text]="true"
                    [rounded]="true"
                    size="small"
                    pTooltip="View"
                    tooltipPosition="top"
                    [routerLink]="['/leads', lead.id]"
                  ></button>
                </div>
              </div>
              <div class="card-date">
                <i class="pi pi-calendar"></i>
                {{ lead.createdAt | date : "MMM d, y" }}
              </div>
              <!-- Drag preview -->
              <div class="drag-preview" *cdkDragPreview>
                <div class="preview-card">
                  <span class="phone-number">{{ lead.phoneNumber }}</span>
                  <span class="customer-name">{{
                    lead.name || "Unknown"
                  }}</span>
                </div>
              </div>
            </div>
            } @empty {
            <div class="empty-column">
              <i class="pi pi-inbox"></i>
              <span>No leads</span>
            </div>
            }
          </div>
        </div>
        } @empty {
        <div class="empty-board">
          <i class="pi pi-th-large"></i>
          <h3>No columns available</h3>
          <p>Configure lead statuses to see the kanban board</p>
        </div>
        }
      </div>

      @if (loading()) {
      <div class="loading-overlay">
        <i class="pi pi-spin pi-spinner"></i>
        <span>Loading leads...</span>
      </div>
      }
    </div>
  </div>

  <!-- Edit Dialog -->
  <app-lead-edit-dialog
    [lead]="selectedLead()"
    [(visible)]="editDialogVisible"
    (leadUpdated)="onLeadUpdated($event)"
  />

  <!-- Status Change Comment Dialog -->
  <p-dialog
    [(visible)]="statusChangeDialogVisible"
    header="Add Comment"
    [modal]="true"
    [draggable]="false"
    [resizable]="false"
    [style]="{ width: '400px', maxWidth: '95vw' }"
    styleClass="status-dialog"
    [closable]="false"
    appendTo="body"
  >
    <div class="dialog-content">
      @if (pendingStatusChange) {
      <p class="status-change-info">
        Moving lead to
        <strong>{{ getStatusTitle(pendingStatusChange.targetStatus) }}</strong>
      </p>
      }
      <div class="form-field">
        <label class="field-label">Comment (optional)</label>
        <textarea
          pTextarea
          [(ngModel)]="statusChangeComment"
          placeholder="Add a comment about this status change..."
          rows="3"
          class="w-full"
        ></textarea>
      </div>
      <div
        class="dialog-footer"
        style="
          margin-top: 1rem;
          display: flex;
          justify-content: flex-end;
          gap: 0.5rem;
        "
      >
        <button
          pButton
          label="Cancel"
          [text]="true"
          class="cancel-btn"
          (click)="onStatusChangeCancel()"
        ></button>
        <button
          pButton
          label="Confirm"
          icon="pi pi-check"
          (click)="onStatusChangeConfirm()"
          class="save-btn"
        ></button>
      </div>
    </div>
  </p-dialog>
</app-layout>
