<app-layout>
  <p-toast />
  <p-confirmDialog />

  <div class="page-container">
    <!-- Page Header -->
    <div class="page-header">
      <div class="header-content">
        <h1 class="page-title">Connector Master</h1>
        <p class="page-subtitle">
          Manage integrations with external platforms and webhooks
        </p>
      </div>

      <!-- Search in header -->
      <div class="header-search">
        <div class="search-wrapper">
          <i class="pi pi-search search-icon"></i>
          <input
            pInputText
            type="text"
            placeholder="Search connectors..."
            class="search-input"
            (input)="onSearch($event)"
          />
        </div>
      </div>

      @if (authService.isAdmin() || authService.isManager()) {
      <button
        pButton
        label="Add Connector"
        icon="pi pi-plus"
        class="add-btn"
        (click)="openCreateDialog()"
      ></button>
      }
    </div>

    <!-- Connector Type Cards -->
    <div class="connector-types-grid">
      @if (connectorService.connectorTypes().length === 0) {
      <div class="loading-types">
        <i class="pi pi-spin pi-spinner"></i>
        <span>Loading connector types...</span>
      </div>
      } @else { @for (type of connectorService.connectorTypes(); track
      type.type) {
      <div
        class="connector-type-card"
        [class.has-connector]="hasConnectorOfType(type.type)"
        (click)="selectConnectorType(type)"
      >
        <div class="type-icon" [attr.data-type]="type.type">
          <i class="pi" [ngClass]="type.icon"></i>
        </div>
        <div class="type-info">
          <h3>{{ type.name }}</h3>
          <p>{{ type.description }}</p>
        </div>
        <div class="type-status">
          @if (hasConnectorOfType(type.type)) {
          <span class="status-badge connected">
            <i class="pi pi-check-circle"></i> Connected
          </span>
          } @else {
          <span class="status-badge not-connected">
            <i class="pi pi-circle"></i> Not Connected
          </span>
          }
        </div>
      </div>
      } }
    </div>

    <!-- Active Connectors Table -->
    <div class="section-header">
      <h2 class="section-title">
        <i class="pi pi-list"></i> Active Connectors
      </h2>
    </div>

    <div class="table-card">
      <p-table
        #dt
        [value]="connectorService.connectors()"
        [loading]="connectorService.loading()"
        [paginator]="true"
        [rows]="10"
        [rowsPerPageOptions]="[5, 10, 25, 50]"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Showing {first} to {last} of {totalRecords} connectors"
        [globalFilterFields]="['name', 'type']"
        styleClass="p-datatable-striped"
      >
        <ng-template pTemplate="header">
          <tr>
            <th pSortableColumn="name">
              Connector <p-sortIcon field="name"></p-sortIcon>
            </th>
            <th pSortableColumn="type" class="type-col">
              Type <p-sortIcon field="type"></p-sortIcon>
            </th>
            <th pSortableColumn="status" class="status-col">
              Status <p-sortIcon field="status"></p-sortIcon>
            </th>
            <th class="sync-col">Last Sync</th>
            <th class="actions-col">Actions</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-connector>
          <tr>
            <td>
              <div class="connector-name">
                <div class="connector-icon" [attr.data-type]="connector.type">
                  <i
                    class="pi"
                    [ngClass]="
                      connectorService.getConnectorIcon(connector.type)
                    "
                  ></i>
                </div>
                <div class="connector-details">
                  <span class="name">{{ connector.name }}</span>
                  <span class="description">{{
                    connector.description || "No description"
                  }}</span>
                </div>
              </div>
            </td>
            <td class="type-col">
              <p-tag
                [value]="getTypeName(connector.type)"
                [severity]="getTypeSeverity(connector.type)"
              />
            </td>
            <td class="status-col">
              <div
                class="status-indicator"
                [class.connected]="connector.status === 'connected'"
                [class.error]="connector.status === 'error'"
                [class.disconnected]="connector.status === 'disconnected'"
              >
                <span class="status-dot"></span>
                <span>{{ connector.status | titlecase }}</span>
              </div>
            </td>
            <td class="sync-col">
              @if (connector.lastSyncAt) {
              <span class="last-sync">{{
                connector.lastSyncAt | date : "short"
              }}</span>
              } @else {
              <span class="no-sync">Never</span>
              }
            </td>
            <td class="actions-col">
              <div class="action-buttons">
                <button
                  pButton
                  icon="pi pi-cog"
                  [rounded]="true"
                  [text]="true"
                  size="small"
                  class="config-btn"
                  pTooltip="Configure"
                  tooltipPosition="top"
                  (click)="configureConnector(connector)"
                ></button>
                <button
                  pButton
                  icon="pi pi-refresh"
                  [rounded]="true"
                  [text]="true"
                  size="small"
                  class="test-btn"
                  pTooltip="Test Connection"
                  tooltipPosition="top"
                  (click)="testConnection(connector)"
                ></button>
                @if (authService.isAdmin()) {
                <button
                  pButton
                  icon="pi pi-trash"
                  [rounded]="true"
                  [text]="true"
                  size="small"
                  severity="danger"
                  class="delete-btn"
                  pTooltip="Delete"
                  tooltipPosition="top"
                  (click)="confirmDelete(connector)"
                ></button>
                }
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="5">
              <div class="empty-state">
                <i class="pi pi-plug"></i>
                <h3>No connectors configured</h3>
                <p>
                  Add a connector to start receiving leads from external
                  platforms
                </p>
                @if (authService.isAdmin() || authService.isManager()) {
                <button
                  pButton
                  label="Add Connector"
                  icon="pi pi-plus"
                  (click)="openCreateDialog()"
                ></button>
                }
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>

  <!-- Create Connector Dialog -->
  <p-dialog
    [(visible)]="createDialogVisible"
    header="Add New Connector"
    [modal]="true"
    [draggable]="false"
    [resizable]="false"
    [style]="{ width: '500px', maxWidth: '95vw' }"
    styleClass="connector-dialog"
  >
    <div class="dialog-content">
      <div class="form-row">
        <div class="form-field">
          <label>Connector Type <span class="required">*</span></label>
          <p-select
            [options]="connectorService.connectorTypes()"
            [(ngModel)]="selectedType"
            optionLabel="name"
            placeholder="Select type"
            class="w-full"
          >
            <ng-template let-type pTemplate="item">
              <div class="type-option">
                <i class="pi" [ngClass]="type.icon"></i>
                <span>{{ type.name }}</span>
              </div>
            </ng-template>
          </p-select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-field">
          <label>Name <span class="required">*</span></label>
          <input
            pInputText
            [(ngModel)]="newConnector.name"
            placeholder="e.g., Facebook Lead Ads"
            class="w-full"
          />
        </div>
      </div>
      <div class="form-row">
        <div class="form-field">
          <label>Description</label>
          <input
            pInputText
            [(ngModel)]="newConnector.description"
            placeholder="Optional description"
            class="w-full"
          />
        </div>
      </div>
    </div>
    <ng-template pTemplate="footer">
      <div class="dialog-footer">
        <button
          pButton
          label="Cancel"
          [text]="true"
          class="cancel-btn"
          (click)="createDialogVisible = false"
        ></button>
        <button
          pButton
          label="Create"
          icon="pi pi-check"
          (click)="createConnector()"
          [loading]="creating()"
          [disabled]="!selectedType || !newConnector.name"
          class="save-btn"
        ></button>
      </div>
    </ng-template>
  </p-dialog>
</app-layout>
